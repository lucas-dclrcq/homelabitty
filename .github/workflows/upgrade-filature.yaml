name: Upgrade Filature

on:
  workflow_dispatch:
    inputs:
      image_sha:
        description: "Filature docker image sha"
        required: true

permissions:
  contents: write

jobs:
  upgrade:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Update HelmRelease File
        env:
          SHA256: ${{ inputs.image_sha }}
        run: |
          VERSION="jvm-development@sha256:${SHA256}" yq eval '.spec.values.controllers.filature.containers.main.image.tag = strenv(VERSION)' \
            -i kubernetes/apps/default/filature/app/helmrelease.yaml
      - uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9
        with:
          message: 'chore(filature): upgrade to latest'
          add: 'kubernetes/apps/default/filature/app/helmrelease.yaml --force'
          committer_name: Homelab Bot
          committer_email: homelab@bot.com
          push: true
