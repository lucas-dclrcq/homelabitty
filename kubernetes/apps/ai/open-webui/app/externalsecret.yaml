---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name open-webui
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: akeyless-secret-store
  target:
    name: *name
    template:
      data:
        # OAUTH
        ENABLE_OAUTH_SIGNUP: "true"
        ENABLE_OAUTH_PERSISTENT_CONFIG: "false"
        OAUTH_MERGE_ACCOUNTS_BY_EMAIL: "true"
        OAUTH_PROVIDER_NAME: "SSO"
        OPENID_PROVIDER_URL: https://sso.${SECRET_DOMAIN}/application/o/open-webui/.well-known/openid-configuration
        OAUTH_SCOPES: openid email profile
        OPENID_REDIRECT_URI: https://ai.${SECRET_DOMAIN}/oauth/oidc/callback
        OAUTH_CLIENT_ID: "{{ .OPEN_WEBUI_CLIENT_ID }}"
        OAUTH_CLIENT_SECRET: "{{ .OPEN_WEBUI_CLIENT_SECRET }}"
        # Database
        DATABASE_URL: "{{ .pg_uri }}"
        # LLM
        OPENAI_API_KEY: "{{ .OPENAI_API_KEY }}"
        ENABLE_OPENAI_API: "True"
        ENABLE_OLLAMA_API: "False"
        ENABLE_IMAGE_GENERATION: "True"
        # Image Generation
        IMAGE_GENERATION_ENGINE: "automatic1111"
        IMAGE_GENERATION_MODEL: "dreamshaper_8"
        IMAGE_SIZE: "400x400"
        IMAGE_STEPS: "8"
        # OTEL
        ENABLE_OTEL: "true"
        ENABLE_OTEL_METRICS: "true"
        OTEL_EXPORTER_OTLP_ENDPOINT: "http://alloy.observability.svc.cluster.local:4317"
        OTEL_EXPORTER_OTLP_INSECURE: "true"
        OTEL_SERVICE_NAME: "open-webui"
        # RAG
        ENABLE_RAG_WEB_SEARCH: "true"
        ENABLE_SEARCH_QUERY: "true"
        RAG_WEB_SEARCH_ENGINE: searxng
        SEARXNG_QUERY_URL: http://searxng:8080/search?q=<query>
        # Websocket
        ENABLE_WEBSOCKET_SUPPORT: "true"
        WEBSOCKET_MANAGER: "redis"
        WEBSOCKET_REDIS_URL: "redis://open-webui-dragonfly:6379"
  dataFrom:
    - extract:
        key: ai/open-webui
      sourceRef:
        storeRef:
          kind: ClusterSecretStore
          name: hashicorp-vault
    - extract:
        key: postgres-16-pguser-openwebui
      sourceRef:
        storeRef:
          kind: ClusterSecretStore
          name: crunchy-pgo-secrets
      rewrite:
        - regexp:
            source: "(.*)"
            target: "pg_$1"
