---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: livekit
spec:
  interval: 30m
  chart:
    spec:
      chart: livekit-server
      version: 1.7.2
      sourceRef:
        kind: HelmRepository
        name: livekit
        namespace: flux-system
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    # Replica count
    replicaCount: 1

    # Graceful termination - 5 hours as recommended by LiveKit
    terminationGracePeriodSeconds: 18000

    # Environment variables for API keys
    env:
      - name: LIVEKIT_API_KEY
        valueFrom:
          secretKeyRef:
            name: livekit-secret
            key: LIVEKIT_API_KEY
      - name: LIVEKIT_API_SECRET
        valueFrom:
          secretKeyRef:
            name: livekit-secret
            key: LIVEKIT_API_SECRET

    # LiveKit server configuration
    livekit:
      log_level: info

      # WebRTC configuration
      rtc:
        use_external_ip: true
        port_range_start: 50000
        port_range_end: 60000
        tcp_port: 7881

      # Redis configuration - using existing Dragonfly in matrix namespace
      redis:
        address: "synapse-dragonfly.matrix.svc.cluster.local:6379"

      # API keys - placeholder that will be injected via environment variables
      # The actual keys will be set via LIVEKIT_API_KEY and LIVEKIT_API_SECRET env vars
      keys: {}

      # TURN server configuration
      turn:
        enabled: true
        domain: "turn.${SECRET_DOMAIN}"
        tls_port: 5349
        udp_port: 3478
        external_tls: true
        serviceType: "ClusterIP"

    # Load balancer configuration - disabled for Gateway API
    loadBalancer:
      type: disable

    # Autoscaling configuration
    autoscaling:
      enabled: false
      minReplicas: 1
      maxReplicas: 5
      targetCPUUtilizationPercentage: 60

    # Node selector for specific nodes if needed
    nodeSelector: {}

    # Resource configuration
    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 500m
        memory: 1Gi

    # Service configuration
    service:
      type: ClusterIP
