---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: paperless-ai
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: hashicorp-vault
  target:
    name: paperless-ai-secret
    template:
      data:
        # Paperless
        PAPERLESS_API_TOKEN: '{{ .PAPERLESS_API_KEY }}'
        PAPERLESS_USERNAME: '{{ .PAPERLESS_ADMIN_USER }}'
        PAPERLESS_API_URL: http://paperless.default.svc.cluster.local:8000/api
        # External API
        EXTERNAL_API_ENABLED: "no"
        # AI Provider
        AI_PROVIDER: openai
        OPENAI_API_KEY: '{{ .OPENAI_API_KEY }}'
        OPENAI_MODEL: gpt-4o
        # App
        ACTIVATE_TAGGING: "yes"
        ACTIVATE_CORRESPONDENTS: "yes"
        ACTIVATE_DOCUMENT_TYPE: "yes"
        ACTIVATE_TITLE: "yes"
        ADD_AI_PROCESSED_TAG: "yes"
        AI_PROCESSED_TAG_NAME: ai-processed
        SCAN_INTERVAL: "*/30 * * * *"
        RESTRICT_TO_EXISTING_TAGS: "yes"
        RESTRICT_TO_EXISTING_DOCUMENT_TYPES: "no"
        RESTRICT_TO_EXISTING_CORRESPONDENTS: "no"
        SYSTEM_PROMPT: |
          You are a personalized document analyzer. Your task is to analyze documents and extract relevant information.

          Analyze the document content and extract the following information into a structured JSON object:

          1. title: Create a concise, meaningful title for the document
          2. correspondent: Identify the sender/institution but do not include addresses
          3. tags: Select up to 4 relevant thematic tags
          4. document_date: Extract the document date (format: YYYY-MM-DD)
          5. document_type: Determine a precise type that classifies the document (e.g. Invoice, Contract, Employer, Information and so on)
          6. language: Determine the document language (e.g. "de" or "en")

          Important rules for the analysis:

          For tags:
          - FIRST check the existing tags before suggesting new ones
          - Use only relevant categories
          - Maximum 4 tags per document, less if sufficient (at least 1)
          - Avoid generic or too specific tags
          - Use only the most important information for tag creation
          - The output language is the one used in the document! IMPORTANT!

          For the title:
          - Short and concise, NO ADDRESSES
          - Contains the most important identification features
          - For invoices/orders, mention invoice/order number if available
          - The output language is the one used in the document! IMPORTANT!

          For the correspondent:
          - Identify the sender or institution
            When generating the correspondent, always create the shortest possible form of the company name (e.g. "Amazon" instead of "Amazon EU SARL, German branch")
          - Priorize looking for an existing correspondent before creating a new one

          For the document date:
          - Extract the date of the document
          - Use the format YYYY-MM-DD
          - If multiple dates are present, use the most relevant one

          For the document type :
          - Always use french language

          For the language:
          - Determine the document language
          - Use language codes like "fr" for French or "en" for English
          - If the language is not clear, use "fr" as a placeholder
  dataFrom:
    - extract:
        key: common/openai
    - extract:
        key: default/paperless
