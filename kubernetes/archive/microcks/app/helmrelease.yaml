---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: microcks
  namespace: infrastructure
spec:
  interval: 15m
  chart:
    spec:
      chart: microcks
      version: 1.7.1
      sourceRef:
        kind: HelmRepository
        name: microcks
        namespace: flux-system

  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  values:
    microcks:
      url: "microcks.${SECRET_DOMAIN}"
      ingressSecretRef: "${SECRET_DOMAIN/./-}-production-tls"
      generateCert: false
      ingressAnnotations:
        external-dns.alpha.kubernetes.io/target: "ingress.${SECRET_DOMAIN}"
        kubernetes.io/ingress.class: "ingress-traefik"
      logLevel: DEBUG
    keycloak:
      install: false
      realm: lulice
      url: "auth.${SECRET_DOMAIN}/auth"
      serviceAccount: microcks-serviceaccount
      serviceAccountCredentials: "${MICROCKS_SA_SECRET}"
    mongodb:
      install: false
      uri: microcks-mongo:27017
      database: microcks
      secretRef:
        secret: microcks-secret
        usernameKey: database-user
        passwordKey: database-password
